#!/bin/sh -eu

sort_and_append() {
    # Sort outputs to make them searchable using bsearch(). Remove
    # last comma.
    sort "$1" | sed '$ s/,$//'
}

pointerize() {
    # Prefix '&' if it's a function, otherwise NULL
    if test "$2" = - -o "$2" = NULL; then
	echo -n NULL
    elif test "${3-}" = internal; then
	# Output the function name
	echo -n "&cmd_$1_$2"
	# Produce C prototype for given function, too
	echo "cmd_$1_t cmd_$1_$2;" >&3
    else
	# Output the function name. no prototype
	echo -n "&$2"
    fi
}

protos="`mktemp`"
ascii="`mktemp`"
modbus="`mktemp`"
exec 3>"$protos"
exec 4>"$ascii"
exec 5>"$modbus"

# File header
cat <<EOF
// Automatically generated file. Edit avr/commands.tsv instead!
#include <stdlib.h>
#include <avr/pgmspace.h>
#include "cmd.h"
#include "juksautin.h"
#include "clock.h"

EOF

# Skip header line
read foo

while read r_type r_address r_name r_read r_write r_printer r_scanner; do
    # Make functions pointers. Also, creates prototypes.
    r_read="`pointerize read "$r_read"`"
    r_write="`pointerize write "$r_write"`"
    r_printer="`pointerize print "$r_printer" internal`"
    r_scanner="`pointerize scan "$r_scanner" internal`"

    # Produce lines for both ASCII interface and Modbus
    action="{ $r_read, $r_write }"
    if test "$r_name" != -; then
	# PROGMEM strings must be outside of array initialization
	echo "static char const name_$r_name[] PROGMEM = \"$r_name\";"
	# The actual array item
	echo "	{ name_$r_name, $action, $r_printer, $r_scanner }," >&4
    fi
    if test "$r_type" != -; then
	echo "	{`printf %2d  "$r_type"`, 0x`printf %04x "$r_address"`, $action }," >&5
    fi
done

# Prototypes. Only once per function.
echo
sort -u $protos

# Ascii table header
cat <<EOF

cmd_ascii_t const cmd_ascii[] PROGMEM = {
EOF

# ASCII table content
sort_and_append "$ascii"

# Boilerplate between ASCII and Modbus tables
cat <<EOF
};

cmd_modbus_t const cmd_modbus[] PROGMEM = {
EOF

# Modbus table content
sort_and_append "$modbus"

# Trailing content
cat <<EOF
};

int const cmd_ascii_len = sizeof(cmd_ascii) / sizeof(*cmd_ascii);
int const cmd_modbus_len = sizeof(cmd_modbus) / sizeof(*cmd_modbus);
EOF

rm "$protos" "$ascii" "$modbus"
